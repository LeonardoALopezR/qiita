{% from qiita_core.qiita_settings import qiita_config %}
{% from future.utils import viewitems %}
{% extends sitebase.html %}

{%block head%}
<script type="text/javascript" src="{% raw qiita_config.portal_dir %}/static/js/sharing.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    qiita_websocket.init(window.location.host + '{% raw qiita_config.portal_dir %}/study/list/socket/', error, error);
    qiita_websocket.add_callback('sel', show_alert);
    $("#redbiom-table").dataTable({
      "dom": '<"ps">lfr<t><"footer">ip',
      'footerCallback': function ( row, data, start, end, display ) {

        // // adding total features found
        //
        // var api = this.api(), data;
        // var total_features = api
        //   .column(4)
        //   .data()
        //   .reduce( function (a, b) { return a + b.samples.length; }, 0);
        //
        // $('.footer').addClass("col-md-12 text-right");
        // if (total_features == 0) {
        //   text = '';
        // } else {
        //   if ($("#search_on").val() == 'categories'){
        //     text = 'Found ' + total_features + ' categories.';
        //   } else {
        //     text = 'Found ' + total_features + ' samples.';
        //   }
        // }
        // $('.footer').html(text)
        //
        // // adding selectors for filtering
        //
        // this.api().columns().every( function (iterator) {
        //   var column = this;
        //   if (iterator == 3 && column.data().length != 0) {
        //     var placer = $(".ps");
        //     placer.empty();
        //     placer.append("<b>Filter by Processing paramters</b>: ")
        //     var selector = $('<select><option value=""></option></select>')
        //       .appendTo( placer )
        //       .on('change', function () {
        //         var val = $.fn.dataTable.util.escapeRegex( $(this).val() );
        //         column
        //           .search( val ? '^'+val+'$' : '', true, false )
        //           .draw();
        //       });
        //
        //     var added = [];
        //     column.data().each(function (d){
        //       var cmd = d.command;
        //       if (added.indexOf(cmd) == -1){
        //         added.push(cmd);
        //         selector.append('<option value="' + cmd + '">' + cmd + '</option>');
        //       }
        //     });
        //   }
        // });
      },
      "columns": [
        { "orderable": false,       "width": "15%", "data": "artifact_biom_ids"},
        { "data": "study_title",    "width": "70%" },
        { "data": "study_abstract", "width": "0%" },
        { "data": "study_id",       "width": "15%" },
        { "data": "study_alias",    "width": "0%" }],
      columnDefs: [
        // {type:'natural', targets:[2,6,7]},
        {"targets": [ 2, 4 ], "visible": false},
        // render zero
        {"render": function ( data, type, row, meta ) {
          if (data !== null && data !== undefined && data.length != 0){
            return '<div class="container" style="max-width: 5em;">'+
                     '<div class="row justify-content-md-center">' +
                       '<div class="col-md-1 text-center details-control">&nbsp;</div>' +
                       '<div class="col-md-1 text-center">' + data.length + '</div>' +
                     '</div>' +
                   '</div>';
          } else {
            return 'No BIOMs';
          }
        }, targets: [0]},
        // render the title cell
        {"render": function ( data, type, row, meta ) {
          {% if current_user is not None %}
            result = "<a target='_blank' href='#' data-toggle='modal' data-target='#study-abstract-modal' onclick=\"fillAbstract('studies-table', "+ meta.row +")\">" +
              "<span class='glyphicon glyphicon-file' aria-hidden='true'></span></a> | <a href='{% raw qiita_config.portal_dir %}/study/description/" +
              row.study_id +"' id='study"+ meta.row +"-title'>"+ data +"</a>";
          {% else %}
             result = ""
          {% end %}
            return result
        }, targets: [1]},
        ],
      "language": {
          "search": "Filter results by column data:",
          "loadingRecords": "Please wait - loading information ...",
          "zeroRecords": "  "
      },
  });

  $("#submitForm").submit(function(event){
    event.preventDefault();

    show_loading("redbiom-info");

    var search = $("#search").val();
    var search_on = $("#search_on").val();

    $.post("{% raw qiita_config.portal_dir %}/redbiom/", {'search': search, 'search_on': search_on})
      .done(function ( data ){
        var redbiom_table = $('#redbiom-table').DataTable();
        var redbiom_info = $('#redbiom-info');
        // the next 4 lines reset the column filtering
        var placer = $(".ps");
        redbiom_table.column(3).search("").draw();
        redbiom_table.clear().draw();
        placer.empty();
        if(data.status == "error") {
          bootstrapAlert(data.message.replace("\n", "<br/>"), "danger");
        } else {
          if(data.message != ''){
            redbiom_info.html(
              `<div class="alert alert-warning alert-dismissible" role="alert">
              <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <strong>Warning!</strong> ` + data.message + `</div><br/>`)
          } else if(data.data){
            redbiom_table.rows.add(data.data).draw();
            redbiom_info.html('');
          }
        }
      });
    });
  });
</script>

{%end%}

{%block content%}
  <small>Some general instructions!</small>
  <br/><br/>
  <form data-toggle="validator" role="form" id="submitForm">
    <div class="form-group row">
      <div class="col-xs-9">
        <input type="text" class="form-control" name="search" id="search" placeholder="Search" required>
      </div>

      <div class="col-xs-2">
        <select class="selectpicker form-control col-xs-2" name="search_on" id="search_on">
          <option value="metadata">Metadata</option>
          <option checked value="feature">Feature</option>
          <option checked value="taxon">Taxon</option>
        </select>
      </div>
      <div class="col-xs-1">
          <button class="btn btn-default" type="submit"><span class="glyphicon glyphicon-search"></span></button>
      </div>
    </div>
  </form>

  <hr>

  <div class="row">
    <div class="col-md-12" id="redbiom-info"></div>
  </div>
  <div class="row">
    <table id="redbiom-table" class="table table-bordered gray-msg">
      <thead>
        <tr>
          <th>Expand for analysis</th>
          <th>Title</th>
          <th>Abstract</th>
          <th>Study ID</th>
          <th>Study Alias</th>
        </tr>
      </thead>
    </table>
  </div>

{% end %}
